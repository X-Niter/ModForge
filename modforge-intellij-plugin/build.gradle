plugins {
    id 'java'
    id 'org.jetbrains.intellij' version '1.17.2'
}

group 'com.modforge'
version '2.1.0'

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.kohsuke:github-api:1.321'
    implementation 'org.apache.commons:commons-lang3:3.14.0'
    implementation 'com.google.code.gson:gson:2.10.1'
    implementation 'com.squareup.okhttp3:okhttp:4.12.0'
    implementation 'commons-io:commons-io:2.15.1'
    implementation 'org.zeroturnaround:zt-zip:1.16'
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.2'
    testImplementation 'org.mockito:mockito-core:5.10.0'
}

// Configure Gradle IntelliJ Plugin
intellij {
    version = '2025.1'
    type = 'IC' // Target IDE: IntelliJ IDEA Community Edition
    plugins = [
        'java',
        'git4idea',
        'org.jetbrains.plugins.github',
        'org.jetbrains.plugins.terminal',
        // If Minecraft Development plugin is required, add it here
        // 'com.demonwav.minecraft-dev:2025.1-1.8.4'
    ]
}

// Configure Java sourceSets
sourceSets {
    main {
        java {
            srcDirs = ['src/main/java']
        }
        resources {
            srcDirs = ['src/main/resources']
        }
    }
    test {
        java {
            srcDirs = ['src/test/java']
        }
        resources {
            srcDirs = ['src/test/resources']
        }
    }
}

// Set Java compatibility version
java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

// Additional IntelliJ plugin configuration
tasks {
    patchPluginXml {
        sinceBuild = "251"
        untilBuild = "252.*"
        changeNotes = """
            <h2>Version 2.1.0 - May 10, 2025</h2>
            <ul>
                <li><b>Added:</b> Full compatibility with IntelliJ IDEA 2025.1</li>
                <li><b>Added:</b> Java 21 virtual thread optimization</li>
                <li><b>Added:</b> Environment validation and compatibility checking</li>
                <li><b>Added:</b> Improved error handling and recovery mechanisms</li>
                <li><b>Updated:</b> GitHub workflow generation to use JDK 21</li>
                <li><b>Updated:</b> Connection utilities to use modern retry logic</li>
                <li><b>Fixed:</b> Multiple compatibility issues with IntelliJ IDEA 2025.1</li>
                <li><b>Improved:</b> Plugin activation and IDE integration</li>
            </ul>
        """
    }

    runIde {
        jvmArgs = [
            '-Xmx2g',
            '--add-opens=java.base/java.util=ALL-UNNAMED',
            '--add-opens=java.base/java.lang=ALL-UNNAMED'
        ]
    }

    // JUnit 5 integration
    test {
        useJUnitPlatform()
    }

    // Generate JAR with sources for debugging
    jar {
        from sourceSets.main.allSource
        manifest {
            attributes(
                'Implementation-Title': 'ModForge IntelliJ Plugin',
                'Implementation-Version': version,
                'Built-By': System.getProperty('user.name'),
                'Build-Timestamp': new java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
                'Created-By': "Gradle ${gradle.gradleVersion}",
                'Build-Jdk': "${System.getProperty('java.version')} (${System.getProperty('java.vendor')} ${System.getProperty('java.vm.version')})",
                'Build-OS': "${System.getProperty('os.name')} ${System.getProperty('os.arch')} ${System.getProperty('os.version')}"
            )
        }
    }
}

// Add verification tasks
tasks.register('validatePluginForProduction') {
    group = 'verification'
    description = 'Validates that the plugin is ready for production deployment'

    doLast {
        println "Validating plugin for production deployment..."
        
        // Check Java version
        def javaVersion = System.getProperty('java.version')
        def javaVersionMajor = javaVersion.split('\\.')[0].toInteger()
        if (javaVersionMajor < 21) {
            throw new GradleException("Invalid Java version: $javaVersion. Java 21 or higher is required.")
        }
        println "✓ Java version check passed: $javaVersion"
        
        // Check plugin version
        if (version == '1.0-SNAPSHOT') {
            throw new GradleException("Plugin version is still set to development snapshot. Set a proper release version.")
        }
        println "✓ Plugin version check passed: $version"
        
        // Check until-build is properly set
        if (!tasks.patchPluginXml.untilBuild.get().endsWith(".*")) {
            throw new GradleException("untilBuild should end with '.*' to support minor IDE updates")
        }
        println "✓ Plugin build range check passed: ${tasks.patchPluginXml.sinceBuild.get()} - ${tasks.patchPluginXml.untilBuild.get()}"
        
        println "✓ Plugin validation completed successfully"
    }
}

// Link validation to build
tasks.buildPlugin.dependsOn(validatePluginForProduction)